# C module modularity & standards report (report_1)

Summary
- Build: OK (`make` succeeded)
- Tests: OK (`make test` all tests passed)
- Modularity: Pass with minor issues found and fixed (see patches)

High/critical findings
- **render_3d_sprite (include/snake/render_3d_sprite.h)** — severity: high
  - Problem: public header used include-guards (not `#pragma once`) and exposed internal/derived fields of `Sprite3D` (e.g., `perp_distance`, `screen_x`, `visible`) which leaks implementation details and breaks encapsulation.
  - Impact: breaks module encapsulation and makes future internal refactors ABI-breaking for callers; exposes fields callers shouldn't touch.
  - Fix applied (exact change): made `Sprite3D` opaque and replaced include-guard with `#pragma once`. Added an internal header with the full struct for implementation only.
    - Files changed:
      - include/snake/render_3d_sprite.h (now uses `#pragma once` and `typedef struct Sprite3D Sprite3D;`)
      - include/snake/render_3d_sprite_internal.h (new — contains full `struct Sprite3D` with derived fields)
      - src/render/sprite.c (now includes `snake/render_3d_sprite_internal.h`)
    - Minimal diff (abridged):
      - Before (in public header): `typedef struct Sprite3D { float world_x,...; float perp_distance; int screen_x; ... } Sprite3D;`
      - After (public header): `typedef struct Sprite3D Sprite3D;`
      - Internal: `struct Sprite3D { /* public fields */ ... /* derived fields */ float perp_distance; int screen_x; ... }` in `render_3d_sprite_internal.h`
  - Tests: build + tests passed after the change.

Major/medium findings
- **game.h ownership docs** — severity: medium
  - Problem: `game_create()` returned a `Game*` without an explicit ownership sentence in the header.
  - Impact: subtle API/ownership ambiguity for callers and maintainers.
  - Fix applied: Added an ownership comment above `game_create()`:
    - `/* Ownership: caller owns the returned `Game*` and must call `game_destroy()` when finished. */`
    - File: include/snake/game.h

- **Large rendering function(s)** — severity: medium
  - Files: `src/render/render.c` (e.g., `render_draw()` ~85 LOC and other related helpers)
  - Issue: functions are getting long and handle many responsibilities (UI/layout, score merging, session-state checks). This is not an immediate correctness issue, but refactoring into smaller functions (draw_map, draw_scores, draw_startup_screen, etc.) would improve readability and testability.
  - Suggested fix: split `render_draw()` into smaller functions and add unit tests for display scoring and session score dedup.

Minor/low findings & notes
- Header hygiene: except for the sprite header, all public headers use `#pragma once` and follow opaque typedef patterns where appropriate. (Checked: include/snake/*.h)
- Globals: globals are held `static` in implementation files (e.g., `src/render/render.c` has `static DisplayContext* g_display`). These are acceptable per coding standards but should include documented accessors/test hooks if external tests need to mutate them. Consider adding comments where needed.
- TODO/FIXME: None found in source tree (only in non-code samples).
- Formatting: `make format-llm` target is present; the tree builds and tests fine. No formatting failures observed after applied changes.

Tests coverage (per-module)
- `game`: tests present (tests/game/*) — ok
- `net`: tests present (tests/net/*) — ok
- `persist`: tests present (tests/persist/*) — ok
- `render_3d_sprite`: exercised indirectly by rendering tests; build/tests passed after the change — ok
- Many modules have targeted unit tests. If you want, I can generate a coverage matrix (which tests exercise which headers).

Actionable next steps
1. Review and accept the applied patches for `render_3d_sprite` and `game.h`.
2. Consider refactoring `render_draw()` into smaller functions and add tests for display components (scores, startup screen) — medium-priority.
3. Optionally, add explicit unit tests that exercise `render_note_session_score()` behavior (dedup, ordering) — low priority.
4. Re-run CI (formatting target if devs rely on `clang-format` to enforce style).

Applied patches (ready and applied in this branch):
- include/snake/render_3d_sprite.h: make opaque + #pragma once
- include/snake/render_3d_sprite_internal.h: add internal struct
- src/render/sprite.c: include internal header
- include/snake/game.h: ownership comment

Overall verdict
- Modularity: PASS (after the one targeted patch to hide internals). Codebase is well-modularized; headers are clean and tests are present for most modules.

If you want, I can:
- split large rendering functions and add focused unit tests (I can open a small PR with that refactor), or
- generate a more exhaustive per-module JSON report listing `ok: true`/`issues` for each header file.

-- automated report generated by reviewer tool
