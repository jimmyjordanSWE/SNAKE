#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <assert.h>
#include "stb_image.h"

int main(void) {
    const unsigned char bad_png[] = {
        0x89,0x50,0x4e,0x47,0x0d,0x0a,0x1a,0x0a,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x74,0x52,0x4e,0x53,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x89,0x50,0x4e,0x47,
        0x0d,0x0a,0x1a,0x0a,0x00,0x00,0x00,0x00,0x00,0x00,0x50,0x4e,0x47,0x0d,0x00,0x4a
    };
    const char *fn = "test_stb_leak.tmp";
    FILE *f = fopen(fn, "wb");
    if (!f) return 1;
    fwrite(bad_png, 1, sizeof(bad_png), f);
    fclose(f);

    int w=0,h=0,c=0;
    unsigned char *img = stbi_load(fn, &w, &h, &c, 0);
    /* We expect a NULL return or a safely freed image; the call must not crash or leak. */
    if (img) stbi_image_free(img);
    remove(fn);

    printf("test_stb_image_fuzz: OK\n");
    return 0;
}
